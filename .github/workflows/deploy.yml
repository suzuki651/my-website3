# GitHub Actionsã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å
name: Deploy Flask App to Azure App Service

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œã‚‹ãƒˆãƒªã‚¬ãƒ¼ã‚’å®šç¾©
on:
  push:
    branches:
      - main  # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã§å®Ÿè¡Œ
  pull_request:
    branches:
      - main  # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å®Ÿè¡Œ

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“ã§å…±æœ‰ã™ã‚‹ç’°å¢ƒå¤‰æ•°ã‚’å®šç¾©
env:
  AZURE_WEBAPP_NAME: 'hp'    # ğŸ‘ˆ ã”è‡ªèº«ã®Azure App Serviceåã‚’æŒ‡å®š
  PYTHON_VERSION: '3.11'                       # ğŸ‘ˆ Pythonã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®š
  RESOURCE_GROUP: 'ccc'   # ğŸ‘ˆ Azureã®ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—åã‚’æŒ‡å®š

# ã‚¸ãƒ§ãƒ–ã®å®šç¾©
jobs:
  build_and_deploy:
    # å®Ÿè¡Œç’°å¢ƒ
    runs-on: ubuntu-latest
    
    # ã‚¸ãƒ§ãƒ–ã®ã‚¹ãƒ†ãƒƒãƒ—
    steps:
    # 1. ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 2. Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip' # pipã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹ã«ã—ã¦ãƒ“ãƒ«ãƒ‰ã‚’é«˜é€ŸåŒ–
    
    # 3. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt  
    
    # 4. ä¾å­˜é–¢ä¿‚ã®ç¢ºèªã¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    - name: Verify dependencies and syntax
      run: |
        echo "ğŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ç¢ºèª:"
        pip list | grep -E "(Flask|gunicorn|Flask-WTF)"
        echo "ğŸ” ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯:"
        python -c "import app; print('âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸºæœ¬çš„ãªæ§‹æ–‡ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ')"
        echo "ğŸ” Gunicornã®å‹•ä½œç¢ºèª:"
        python -c "import gunicorn; print('âœ… Gunicorn ãŒæ­£å¸¸ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸ')"
    
    # 5. Azureã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
    - name: Deploy to Azure App Service
      uses: azure/webapps-deploy@v2
      with:
        # GitHub Secretsã«è¨­å®šã—ãŸç™ºè¡Œãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }} 
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        slot-name: 'production'
        package: . # ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå…¨ä½“ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        
    # 6. App Serviceã®è¨­å®šã‚’æ›´æ–°ï¼ˆç’°å¢ƒå¤‰æ•°ã®è¨­å®šï¼‰
    - name: Update App Service Configuration
      uses: azure/cli@v2
      with:
        inlineScript: |
          # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šï¼ˆç’°å¢ƒå¤‰æ•°ï¼‰ã‚’ã‚»ãƒƒãƒˆ
          az webapp config appsettings set --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --settings \
            'FLASK_ENV=production' \
            'WEBSITE_RUN_FROM_PACKAGE=0' \
            'PYTHONUNBUFFERED=1' \
            'SECRET_KEY=${{ secrets.SECRET_KEY }}' \
            'EMAIL_HOST=${{ secrets.EMAIL_HOST }}' \
            'EMAIL_PORT=${{ secrets.EMAIL_PORT }}' \
            'EMAIL_USER=${{ secrets.EMAIL_USER }}' \
            'EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}' \
            'EMAIL_FROM=${{ secrets.EMAIL_FROM }}' \
            'DEFAULT_ADMIN_USERNAME=${{ secrets.DEFAULT_ADMIN_USERNAME }}' \
            'DEFAULT_ADMIN_PASSWORD=${{ secrets.DEFAULT_ADMIN_PASSWORD }}' \
            'DEFAULT_ADMIN_EMAIL=${{ secrets.DEFAULT_ADMIN_EMAIL }}' \
            'DEFAULT_ADMIN_SECURITY_QUESTION=${{ secrets.DEFAULT_ADMIN_SECURITY_QUESTION }}' \
            'DEFAULT_ADMIN_SECURITY_ANSWER=${{ secrets.DEFAULT_ADMIN_SECURITY_ANSWER }}'
          
          # æ³¨æ„: web.configã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€èµ·å‹•ã‚³ãƒãƒ³ãƒ‰ã®è¨­å®šã¯ä¸è¦
          
    # 7. ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸã®é€šçŸ¥
    - name: Notify on successful deployment
      run: |
        echo "âœ… Successfully deployed ${{ env.AZURE_WEBAPP_NAME }} to Azure App Service."
        echo "ğŸŒ Application URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"