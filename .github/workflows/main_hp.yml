# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions
# More info on Python, GitHub Actions, and Azure App Service: https://aka.ms/python-webapps-actions

name: Build and deploy Python app to Azure Web App - hp

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      artifact-name: ${{ steps.artifact.outputs.artifact-name }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install gunicorn

    # --- データベース初期化の追加 ---
    # `secrets.` を使用してシークレットを環境変数に渡すように修正
    - name: Initialize the database
      run: |
        python -c "import app; app.init_db()"
        
    - name: Run basic syntax check
      run: |
        echo "Running syntax check..."
        python -m py_compile app.py
        if [ -f "startup.py" ]; then
          python -m py_compile startup.py
        fi
        echo "✅ Syntax check passed"

    - name: Create deployment package
      run: |
        echo "Creating deployment package..."
        mkdir -p deploy
        
        cp app.py deploy/
        cp requirements.txt deploy/
        cp perch_database.db deploy/
        
        if [ -f "startup.py" ]; then
          cp startup.py deploy/
        fi
        if [ -f "startup.sh" ]; then
          cp startup.sh deploy/
        fi
        if [ -f "web.config" ]; then
          cp web.config deploy/
        fi
        if [ -d "templates" ]; then
          cp -r templates deploy/
          echo "✅ Templates copied"
        fi
        if [ -d "static" ]; then
          cp -r static deploy/
          echo "✅ Static files copied"
        fi
        
        if [ -f "deploy/startup.sh" ]; then
          chmod +x deploy/startup.sh
        fi
        
        echo "📦 Deployment package contents:"
        ls -la deploy/

    - name: Upload artifact for deployment job
      id: artifact
      uses: actions/upload-artifact@v3
      with:
        name: python-app
        path: deploy/

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: 'Production'
    
    steps:
    - name: Download artifact from build job
      uses: actions/download-artifact@v3
      with:
        name: python-app

    - name: Login to Azure
      uses: azure/login@v1
      with:
        # `secrets.` を使用してシークレットを参照するように修正
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      id: deploy-to-webapp
      with:
        app-name: 'hp'
        package: .

    - name: Logout from Azure
      run: |
        az logout
      if: always()

    - name: Wait for deployment stabilization
      run: |
        echo "⏳ Waiting for deployment to stabilize..."
        sleep 60

    - name: Health check and validation
      run: |
        APP_URL="https://hp.azurewebsites.net"
        HEALTH_URL="${APP_URL}/health"
        
        echo "🔍 Checking health endpoint: $HEALTH_URL"
        
        for i in {1..5}; do
          echo "🏥 Health check attempt $i/5"
          
          if curl -f -s "$HEALTH_URL" > /dev/null 2>&1; then
            echo "✅ Health check passed!"
            echo "🎉 Application deployed successfully!"
            echo "🌐 App URL: $APP_URL"
            echo "👤 Admin URL: ${APP_URL}/admin/login"
            echo "🔧 Health URL: $HEALTH_URL"
            exit 0
          else
            echo "❌ Health check failed, retrying in 30 seconds..."
            if [ $i -lt 5 ]; then
              sleep 30
            fi
          fi
        done
        
        echo "⚠️ Health check failed after 5 attempts"
        echo "🌐 App URL: $APP_URL"
        echo "👤 Admin URL: ${APP_URL}/admin/login"
        echo "📊 Please check the Azure portal for deployment status"
        echo "🔗 Azure Portal: https://portal.azure.com"
        echo "ℹ️ Note: The application may still be starting up."
        echo "ℹ️ Please wait a few more minutes and check the URL manually."
        exit 0
