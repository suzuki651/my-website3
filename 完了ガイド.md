# 🎉 修正完了とデプロイガイド

すべてのコード修正が完了し、GitHubにプッシュされました！

---

## ✅ 完了した作業

### 1. コードの問題を修正
- ✅ セキュリティ問題の修正（機密情報の環境変数化）
- ✅ CSRF時間制限の設定（1時間）
- ✅ デバッグコードの条件分岐化
- ✅ 重複コードのリファクタリング
- ✅ SECRET_KEYを強力なランダム値に更新

### 2. GitHubへのプッシュ完了
- ✅ リポジトリ: https://github.com/suzuki651/my-website3
- ✅ すべての変更をプッシュ済み
- ✅ Azure設定を `hpsystem` 用に更新済み

---

## 📝 残りの作業（あなたが実施）

### ステップ1: Azure Service Principalの作成

⚠️ **重要**: Azureで**基本認証が無効**になっているため、Service Principalを使用します。

#### 1-1. Azure Cloud Shellでコマンド実行

1. Azure Portal (https://portal.azure.com) にアクセス
2. 右上のCloud Shellアイコン（`>_`）をクリック
3. サブスクリプションIDを確認:
   - Azure Portal → 「サブスクリプション」 → IDをコピー
4. 以下のコマンドを実行（**{subscription-id}** を実際のIDに置き換え）:

```bash
az ad sp create-for-rbac --name "github-actions-hpsystem" \
  --role contributor \
  --scopes /subscriptions/{subscription-id}/resourceGroups/ccc/providers/Microsoft.Web/sites/hpsystem \
  --sdk-auth
```

5. 出力されたJSON全体をコピー

詳細は `Azure_Service_Principal設定ガイド.md` を参照してください。

---

### ステップ2: GitHub Secretsの設定

以下のURLにアクセスして、Secretsを設定してください：

```
https://github.com/suzuki651/my-website3/settings/secrets/actions
```

#### 設定するSecrets（12個）

「New repository secret」ボタンをクリックして、以下を1つずつ追加：

| Secret名 | 値 |
|---------|-----|
| `AZURE_CREDENTIALS` | ※ステップ1で取得したJSON全体 |
| `SECRET_KEY` | `129fdcd8c2c21668198ca8868fe6d9371d4d5f649a03b834aa1004248e19f23d` |
| `EMAIL_HOST` | `smtp.gmail.com` |
| `EMAIL_PORT` | `587` |
| `EMAIL_USER` | `suzuki651iris1@gmail.com` |
| `EMAIL_PASSWORD` | `tkojkvjhldokssjp` |
| `EMAIL_FROM` | `suzuki651iris1@gmail.com` |
| `DEFAULT_ADMIN_USERNAME` | `admin` |
| `DEFAULT_ADMIN_PASSWORD` | `admin1q2w3e` |
| `DEFAULT_ADMIN_EMAIL` | `suzuki651iris1@gmail.com` |
| `DEFAULT_ADMIN_SECURITY_QUESTION` | `あなたの最初のペットの名前は？` |
| `DEFAULT_ADMIN_SECURITY_ANSWER` | `pet` |

---

### ステップ3: 自動デプロイの確認

Secretsを設定すると、GitHub Actionsが自動的に実行されます。

**GitHub Actionsページ:**
```
https://github.com/suzuki651/my-website3/actions
```

- すべてのステップが緑色のチェックマークになれば成功！

---

### ステップ4: デプロイされたアプリケーションにアクセス

**アプリケーションURL:**
```
https://hpsystem.azurewebsites.net
```

**管理画面URL:**
```
https://hpsystem.azurewebsites.net/admin/login
```

**ログイン情報:**
- ユーザー名: `admin`
- パスワード: `admin1q2w3e`

---

### ステップ5: セキュリティ対応（重要！）

#### 5-1. 管理者パスワードの変更

1. 管理画面にログイン
2. パスワード変更ページに移動
3. **強力なパスワードに変更**

#### 5-2. データベースの再初期化（推奨）

新しい環境変数を反映させるため：

1. Azure Portal → `hpsystem` → 「SSH」
2. 以下のコマンドを実行：
   ```bash
   rm /home/perch_database.db
   ```
3. Azure Portal → `hpsystem` → 「再起動」

これで新しい環境変数でデータベースが再作成されます。

---

## 🔧 便利なスクリプト（オプション）

GitHub CLIを使ってSecretsを自動設定したい場合：

### Windowsの場合（PowerShell）

```powershell
# GitHub CLIをインストール
winget install --id GitHub.cli

# 認証
gh auth login

# Secretsを自動設定
.\setup_github_secrets.ps1
```

### macOS/Linuxの場合（Bash）

```bash
# GitHub CLIをインストール (Homebrewを使用)
brew install gh

# 認証
gh auth login

# Secretsを自動設定
./setup_github_secrets.sh
```

**注意:** `AZURE_CREDENTIALS` だけは手動で設定する必要があります（Azure Cloud Shellでコマンド実行）。

---

## 📊 実施されたGitコミット

```
b7e8ff6 - Add GITHUB_SECRETS_SETUP.md to .gitignore for security
6714156 - Update Azure configuration for hpsystem deployment
330838e - Merge with security improvements
e2de9e6 - Add comprehensive deployment guide for GitHub and Azure
12101c6 - Add default admin environment variables to GitHub Actions workflow
922dc03 - Initial commit: Flask お問い合わせ管理システム
```

---

## 📚 参考ドキュメント

- **Azure_Service_Principal設定ガイド.md** - Service Principal作成の詳細手順
- **DEPLOYMENT.md** - 詳細なデプロイガイド
- **GITHUB_SECRETS_SETUP.md** - Secrets設定の詳細（ローカルのみ）
- **README.md** - アプリケーションの使い方

---

## ⚠️ 重要な注意事項

1. **GITHUB_SECRETS_SETUP.md** ファイルには機密情報が含まれています
   - Gitにコミットされません（.gitignoreに追加済み）
   - Secrets設定後は削除を推奨

2. **デプロイ後、必ずパスワードを変更してください**
   - デフォルトパスワード `admin1q2w3e` は弱いパスワードです

3. **本番環境では以下を確認してください**
   - SECRET_KEYが強力なランダム値であること
   - 管理者パスワードが変更されていること
   - メール送信が正常に機能すること

---

## 🆘 トラブルシューティング

### GitHub Actionsが失敗する場合

1. すべてのSecretsが設定されているか確認
2. `AZURE_CREDENTIALS` が正しいJSON形式か確認
3. Service Principalに適切な権限があるか確認

### アプリケーションにアクセスできない場合

1. デプロイが完了しているか確認
2. Azureのログストリームを確認
3. 環境変数が正しく設定されているか確認

### 管理者でログインできない場合

1. データベースが正しく初期化されているか確認
2. 環境変数 `DEFAULT_ADMIN_USERNAME` と `DEFAULT_ADMIN_PASSWORD` を確認
3. データベースを削除して再起動

詳細は `DEPLOYMENT.md` の「トラブルシューティング」セクションを参照してください。

---

## 🎊 完了！

GitHub Secretsを設定したら、自動的にAzureにデプロイされます。

デプロイが完了したら、アプリケーションにアクセスして動作を確認してください！

質問や問題がある場合は、`DEPLOYMENT.md` を参照してください。
